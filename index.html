const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const fs = require('fs');
const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(bodyParser.json());

// "БД" у пам'яті
let users = [];

// POST /save - додати або оновити користувача
app.post('/save', (req, res) => {
  const { nick, coins, crystals } = req.body;
  if (!nick) return res.status(400).json({ message: "Нік обов'язковий" });

  const existing = users.find(u => u.nick === nick);
  if (existing) {
    existing.coins = coins ?? existing.coins;
    existing.crystals = crystals ?? existing.crystals ?? 0;
  } else {
    users.push({ 
      nick, 
      coins: coins ?? 0, 
      crystals: crystals ?? 0 
    });
  }
  res.json({ message: "Дані збережено" });
});

// POST /update - редагування монет або кристалів вручну
app.post('/update', (req, res) => {
  const { nick, coins, crystals } = req.body;
  const user = users.find(u => u.nick === nick);
  if (!user) return res.status(404).json({ message: "Гравець не знайдений" });

  user.coins = coins ?? user.coins;
  user.crystals = crystals ?? user.crystals;
  res.json({ message: `Дані гравця ${nick} оновлено` });
});

// GET /db - повертає HTML таблицю
app.get('/db', (req, res) => {
  fs.readFile('db.html', 'utf8', (err, data) => {
    if (err) return res.status(500).send("Помилка читання HTML");

    let tableRows = '';
    users.forEach(u => {
      tableRows += `<tr>
        <td>${u.nick}</td>
        <td><input type="number" value="${u.coins}" data-nick="${u.nick}" data-type="coins"></td>
        <td><input type="number" value="${u.crystals}" data-nick="${u.nick}" data-type="crystals"></td>
        <td><button onclick="updatePlayer('${u.nick}', this)">Зберегти</button></td>
      </tr>`;
    });

    const htmlWithTable = data.replace('<!--TABLE_ROWS-->', tableRows);
    res.send(htmlWithTable);
  });
});

// GET / - також повертає HTML таблицю
app.get('/', (req, res) => {
  fs.readFile('db.html', 'utf8', (err, data) => {
    if (err) return res.status(500).send("Помилка читання HTML");

    let tableRows = '';
    users.forEach(u => {
      tableRows += `<tr>
        <td>${u.nick}</td>
        <td><input type="number" value="${u.coins}" data-nick="${u.nick}" data-type="coins"></td>
        <td><input type="number" value="${u.crystals}" data-nick="${u.nick}" data-type="crystals"></td>
        <td><button onclick="updatePlayer('${u.nick}', this)">Зберегти</button></td>
      </tr>`;
    });

    const htmlWithTable = data.replace('<!--TABLE_ROWS-->', tableRows);
    res.send(htmlWithTable);
  });
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
