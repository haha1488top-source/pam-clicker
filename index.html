<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Моя гра</title>

<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    width: 100%; height: 100%;
    font-family: Arial; background: #87CEEB;
  }

  #nickname-screen, #game-screen, #shop-screen {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex; justify-content: center; align-items: center;
  }

  #game-screen, #shop-screen { display: none; }

  #player-image {
    width: 150px; position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
  }

  #nickname-display {
    position: absolute; top: 10px; left: 10px;
    color: white; font-size: 20px; font-weight: bold;
  }

  #logout-btn {
    position: absolute; top: 10px; right: 10px;
    padding: 5px 10px; background: red;
    color: white; border-radius: 5px; cursor: pointer;
  }

  #shop-btn {
    position: absolute;
    top: 100px;
    left: 10px;
    padding: 10px 20px;
    background: purple;
    color: white;
    border-radius: 5px;
    font-size: 18px;
    cursor: pointer;
  }

  #shop-screen {
    background: #66ccff;
    flex-direction: column;
  }

  #event-info {
    font-size: 30px;
    color: white;
    margin-bottom: 20px;
  }

  #back-btn {
    padding: 10px 20px;
    font-size: 20px;
    background: black;
    color: white;
    border-radius: 5px;
    cursor: pointer;
  }

  #currency-bar {
    position: absolute; top: 10px; left: 50%;
    transform: translateX(-50%);
    display: flex; gap: 20px;
  }
  .currency { display: flex; color: white; font-size: 24px; }
  .currency-icon { width: 30px; margin-right: 5px; }
</style>
</head>

<body>

<!-- Нікнейм -->
<div id="nickname-screen">
  <input id="nickname-input" placeholder="Введіть нікнейм">
  <button id="set-nickname">Почати гру</button>
</div>

<!-- Гра -->
<div id="game-screen">
  <div id="nickname-display"></div>
  <button id="logout-btn">Вихід</button>
  <button id="shop-btn">Магазин</button>

  <div id="currency-bar">
    <div class="currency"><img src="coin.png" class="currency-icon"><span id="coin-count">0</span></div>
    <div class="currency"><img src="gem.png" class="currency-icon"><span id="crystal-count">0</span></div>
  </div>

  <img id="player-image" src="pam_egg_pam_pin.png">
</div>

<!-- Магазин -->
<div id="shop-screen">
  <div id="event-info">Акції немає</div>
  <button id="back-btn">Назад</button>
</div>

<script>
const SERVER_URL = "https://a9899f91-a853-4bd7-af7b-5ee3862e858c-00-3gmthkd6va98d.janeway.replit.dev"; // твій основний сервер
const EVENT_URL  = "https://69f97b4b-bcec-4935-8854-5c0608a65168-00-2axxi9vzawhxt.riker.replit.dev"; // сервер акцій

let nickname = "";
let coins = 0;
let crystals = 0;

const nicknameScreen = document.getElementById('nickname-screen');
const gameScreen = document.getElementById('game-screen');
const shopScreen = document.getElementById('shop-screen');

const playerImage = document.getElementById('player-image');
const nicknameInput = document.getElementById('nickname-input');
const setNicknameBtn = document.getElementById('set-nickname');
const logoutBtn = document.getElementById('logout-btn');
const shopBtn = document.getElementById('shop-btn');
const backBtn = document.getElementById('back-btn');

const coinCountEl = document.getElementById('coin-count');
const crystalCountEl = document.getElementById('crystal-count');
const nicknameDisplayEl = document.getElementById('nickname-display');
const eventInfoEl = document.getElementById('event-info');

// Логін з localStorage
window.addEventListener("DOMContentLoaded", () => {
  const stored = localStorage.getItem("nickname");
  if (stored) {
    nickname = stored;
    startGame();
    loadProgress();
  }
});

// Почати гру
setNicknameBtn.onclick = () => {
  let n = nicknameInput.value.trim();
  if (!n) return alert("Введіть нікнейм!");
  nickname = n;
  localStorage.setItem("nickname", nickname);
  startGame();
  saveData();
};

function startGame() {
  nicknameScreen.style.display = "none";
  gameScreen.style.display = "block";
  nicknameDisplayEl.textContent = nickname;
}

// Клік = монети
playerImage.onclick = () => {
  coins++;
  coinCountEl.textContent = coins;
  saveData();
};

// Вихід
logoutBtn.onclick = () => {
  localStorage.removeItem("nickname");
  location.reload();
};

// В магазин
shopBtn.onclick = () => {
  gameScreen.style.display = "none";
  shopScreen.style.display = "flex";
  loadEvent();
};

// Назад
backBtn.onclick = () => {
  shopScreen.style.display = "none";
  gameScreen.style.display = "block";
};

// Завантажити акцію
function loadEvent() {
  fetch(EVENT_URL + "/event")
    .then(r => r.json())
    .then(event => {
      if (!event) {
        eventInfoEl.textContent = "Акції немає";
        return;
      }
      eventInfoEl.textContent =
        (event.type === "coins" ? "Монет: " : "Кристалів: ") +
        event.amount;
    });
}

// Зберегти
function saveData() {
  fetch(SERVER_URL + "/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nick: nickname, coins, crystals })
  });
}

// Завантажити
function loadProgress() {
  fetch(SERVER_URL + "/db")
    .then(r => r.text())
    .then(html => {
      const doc = new DOMParser().parseFromString(html, "text/html");
      doc.querySelectorAll("tbody tr").forEach(row => {
        const td = row.querySelectorAll("td");
        if (td[0].textContent === nickname) {
          coins = parseInt(td[1].textContent);
          crystals = parseInt(td[2].textContent);
          coinCountEl.textContent = coins;
          crystalCountEl.textContent = crystals;
        }
      });
    });
}
</script>

</body>
</html>
